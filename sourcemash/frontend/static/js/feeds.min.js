window.Sourcemash={Models:{},Collections:{},Views:{},Routers:{},initialize:function(){new Sourcemash.Routers.AppRouter();Backbone.history.start();}};$(document).ready(function(){Sourcemash.initialize();});Sourcemash.Models.Category=Backbone.Model.extend({urlRoot:'/api/categories',initialize:function(){this.items=new Sourcemash.Collections.CategoryItems([],{category:this});}});Sourcemash.Models.Feed=Backbone.Model.extend({urlRoot:'/api/feeds',initialize:function(){this.items=new Sourcemash.Collections.Items([],{feed:this});},parse:function(response){return response.feed;}});Sourcemash.Models.Item=Backbone.Model.extend({urlRoot:'api/items'});Sourcemash.Collections.Categories=Backbone.Collection.extend({model:Sourcemash.Models.Category,url:'/api/categories',parse:function(response){return response.categories;},comparator:'category'});Sourcemash.Collections.CategoryItems=Backbone.Collection.extend({model:Sourcemash.Models.Item,url:function(){return'/api/categories/'+this.category.get('category')},parse:function(response){return response.items;},initialize:function(items,options){this.category=options.category;}});Sourcemash.Collections.Feeds=Backbone.Collection.extend({model:Sourcemash.Models.Feed,url:'/api/feeds',parse:function(response){return response.feeds;},comparator:'title'});Sourcemash.Collections.Items=Backbone.Collection.extend({model:Sourcemash.Models.Item,url:function(){return'/api/feeds/'+this.feed.get('id')+'/items'},parse:function(response){return response.items;},initialize:function(items,options){this.feed=options.feed;}});Sourcemash.Collections.Subscriptions=Backbone.Collection.extend({model:Sourcemash.Models.Feed,url:'/api/subscriptions',parse:function(response){return response.subscriptions;},comparator:'title'});Sourcemash.Views.CategoriesView=Backbone.View.extend({template:JST['categories'],initialize:function(){this.listenTo(this.collection,'add sync remove change',this.render);},render:function(){var content=this.template({categories:this.collection.models})
this.$el.html(content);return this;},});Sourcemash.Views.CategoryView=Backbone.View.extend({template:JST['category'],initialize:function(options){this.listenTo(this.model,'sync',this.render);this.listenTo(this.model.items,'sync',this.render);},render:function(){var content=this.template({category:this.model});this.$el.html(content);return this;}});Sourcemash.Views.FeedView=Backbone.View.extend({template:JST['feed'],initialize:function(options){this.listenTo(this.model,'sync',this.render);this.listenTo(this.model.items,'sync',this.render);},render:function(){var content=this.template({feed:this.model});this.$el.html(content);return this;},refresh:function(event){this.model.entries.fetch();}});Sourcemash.Views.FeedsView=Backbone.View.extend({template:JST['feeds'],initialize:function(){this.listenTo(this.collection,'add sync remove change',this.render);},events:{'submit #add_feed_form':'createFeed'},createFeed:function(e){e.preventDefault()
this.collection.create(this.newAttributes(),{wait:true,url:this.collection.url,success:this.updateCollection});},updateCollection:function(newFeed){this.$('#url').val('');newFeed.collection.fetch();toast('Feed added!',3000)
},render:function(){var content=this.template({feeds:this.collection.models})
this.$el.html(content);return this;},newAttributes:function(){return{url:this.$('#url').val().trim(),}}});Sourcemash.Routers.AppRouter=Backbone.Router.extend({routes:{"":"index","feeds/:id":"showFeed","categories":"showCategories","categories/:category":"showCategory"},index:function(){var feedsView=new Sourcemash.Views.FeedsView({collection:new Sourcemash.Collections.Subscriptions()});feedsView.collection.fetch();this._swapView(feedsView);},showFeed:function(id){var feed=new Sourcemash.Models.Feed({id:id});var feedView=new Sourcemash.Views.FeedView({model:feed});feed.fetch();feed.items.fetch();this._swapView(feedView);},showCategories:function(){var categoriesView=new Sourcemash.Views.CategoriesView({collection:new Sourcemash.Collections.Categories()});categoriesView.collection.fetch();this._swapView(categoriesView);},showCategory:function(keyword){var category=new Sourcemash.Models.Category({category:keyword});var categoryView=new Sourcemash.Views.CategoryView({model:category});category.fetch();category.items.fetch();this._swapView(categoryView);},_swapView:function(view){if(this.currentView){this.currentView.remove();}
this.currentView=view;$('#app').html(view.render().$el);}})