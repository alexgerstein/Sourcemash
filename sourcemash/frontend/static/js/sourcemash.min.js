window.Sourcemash={Models:{},Collections:{},Views:{},Routers:{},initialize:function(){new Sourcemash.Routers.AppRouter();Backbone.history.start();}};var OriginalBackboneSync=Backbone.sync;Backbone.sync=function(method,model,options){if(!options.data&&model&&method==='update'){options.contentType='application/json';options.data=JSON.stringify(model.changedAttributes()||{});if(options.data==="{}"){return};}
return OriginalBackboneSync.apply(this,arguments);};$(document).ready(function(){Sourcemash.initialize();});Sourcemash.Models.Category=Backbone.Model.extend({urlRoot:'/api/categories'});Sourcemash.Models.Feed=Backbone.Model.extend({urlRoot:'/api/feeds',parse:function(response){if(response.feed){return response.feed;}
return response;}});Sourcemash.Models.Item=Backbone.Model.extend({urlRoot:'/api/items',initialize:function(data,options){var existingFeed=options.feeds.findWhere({id:this.get('feed').id});if(existingFeed){this.feed=existingFeed;}else{this.feed=new Sourcemash.Models.Feed({id:this.get('feed').id,subscribed:this.get('feed').subscribed,title:this.get('feed').title});options.feeds.add(this.feed);}}});Sourcemash.Models.User=Backbone.Model.extend({urlRoot:'/api/user',parse:function(response){return response.user;}});Sourcemash.Collections.Categories=Backbone.Collection.extend({model:Sourcemash.Models.Category,url:'/api/categories',parse:function(response){return response.categories;},comparator:function(item){return[parseInt(item.get('unread_count'))===0,item.get('category')]}});Sourcemash.Collections.Feeds=Backbone.Collection.extend({model:Sourcemash.Models.Feed,url:'/api/feeds',parse:function(response){return response.feeds;},comparator:function(feed){return[parseInt(feed.get('unread_count'))===0,feed.get('title')]}});Sourcemash.Collections.Items=Backbone.Collection.extend({model:Sourcemash.Models.Item,url:function(){if(this.feed){return'/api/feeds/'+this.feed.get('id')+'/items'}else if(this.category){return'/api/categories/'+this.category.get('category')+'/items'}else if(this.saved){return'/api/items/saved'}},parse:function(response){return response.items;},initialize:function(items,options){this.feed=options.feed;this.category=options.category;this.saved=options.saved;},comparator:function(item){return[-item.get('unread'),Date.parse(item.get('last_updated'))]}});Sourcemash.Views.ProfileView=Backbone.View.extend({template:JST['profile'],initialize:function(options){this.listenTo(this.model,'change',this.render);},render:function(){var content=this.template({model:this.model})
this.$el.html(content);return this;}});Sourcemash.Views.ItemsView=Backbone.View.extend({initialize:function(options){if(this.model){this.listenTo(this.model,'change',this.render);}
this.itemViews=[];},events:{"click #subscribe-switch":'subscribeFromSwitch','click .subscribe-close':'subscribeFromModal',},subscribeFromSwitch:function(){if(this.model.get('subscribed')){this.model.save({'subscribed':false},{success:this.subscribed});mixpanel.track("Unsubscribed",{"Feed Title":this.model.get('title')})}else{this.model.save({'subscribed':true},{success:this.subscribed});mixpanel.track("Subscribed",{"Feed Title":this.model.get('title'),"Source":'feed page'})}},subscribeFromModal:function(){var item=this.collection.findWhere({title:$('#subscribe-modal #unsubscribed-item-title').text()});item.feed.save({'subscribed':true},{success:this.subscribed})
mixpanel.track("Subscribed",{"Item Title":item.get('title'),"Feed Title":item.feed.get('title'),"Source":'modal'})},subscribed:function(feed){if(feed.get('subscribed')){toast("Subscribed!",3000);}else{toast("You have unsubscribed...",3000);}},render:function(){ this.$el.html(this.template({model:this.model,items:this.collection.models})); this.close();var itemCards=[];this.collection.models.forEach(_.bind(function(item){var itemCardView=new Sourcemash.Views.ItemCardView({el:"#item-"+item.get('id'),model:item});itemCards.push(itemCardView)},this))
this.itemViews=itemCards;return this;},close:function(){_.each(this.itemViews,function(itemView){itemView.remove();itemView.unbind();})}});Sourcemash.Views.CategoryView=Sourcemash.Views.ItemsView.extend({template:JST['category'],id:"category-items"});Sourcemash.Views.CategoriesView=Backbone.View.extend({template:JST['categories'],initialize:function(){this.listenTo(this.collection,'add sync remove change',this.render);},render:function(){var content=this.template({categories:this.collection.models})
this.$el.html(content);return this;},});Sourcemash.Views.FeedView=Sourcemash.Views.ItemsView.extend({template:JST['feed'],id:"feed-items"});Sourcemash.Views.FeedsView=Backbone.View.extend({template:JST['feeds'],initialize:function(options){var ExtendedTypeahead=Backbone.Typeahead.extend({template:JST['new-feed-form'],});this.allFeeds=new Sourcemash.Collections.Feeds()
this.typeahead=new ExtendedTypeahead({collection:this.allFeeds,key:'title'});this.listenTo(this.collection,'sync',this.render);},events:{'submit #add_feed_form':'createFeed'},createFeed:function(e){e.preventDefault()
this.collection.create(this.newAttributes(),{success:this.updateCollection});},updateCollection:function(newFeed){this.$('#url').val('');newFeed.collection.fetch();toast('Feed added!',3000)
mixpanel.track("Subscribed",{"Feed Title":newFeed.get('title'),"Source":'search'})},render:function(){var content=this.template({feeds:this.collection.models})
this.$el.html(content);$('#typeahead').html(this.typeahead.render().el);return this;},newAttributes:function(){var url=this.$('#url').val()
if(!this._isValidURL(url)){var feed=this.allFeeds.findWhere({'title':url});if(feed){url=feed.get('url');}}
return{url:url,}},_isValidURL:function(str){var regexp=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/return regexp.test(str);}});Sourcemash.Views.SavedView=Sourcemash.Views.ItemsView.extend({template:JST['saved'],id:"saved-items"});Sourcemash.Views.BrowseView=Backbone.View.extend({template:JST['browse'],initialize:function(options){var ExtendedTypeahead=Backbone.Typeahead.extend({template:JST['new-feed-form'],});this.typeahead=new ExtendedTypeahead({collection:this.collection,key:'title'});this.listenTo(this.collection,'sync',this.render);},events:{'submit #add_feed_form':'createFeed',},createFeed:function(e){e.preventDefault()
this.collection.create(this.newAttributes(),{success:this.updateCollection});},updateCollection:function(newFeed){this.$('#url').val('');newFeed.collection.fetch();toast('Feed added!',3000)
mixpanel.track("Subscribed",{"Feed Title":newFeed.get('title'),"Source":'search'})},render:function(){ this.$el.html(this.template({models:this.collection.models}));$('#typeahead').html(this.typeahead.render().el); this.close();var feedCards=[];this.collection.models.forEach(_.bind(function(feed){var feedCardView=new Sourcemash.Views.FeedCardView({el:"#feed-card-"+feed.get('id'),model:feed});feedCards.push(feedCardView)},this))
this.feedViews=feedCards;return this;},newAttributes:function(){var url=this.$('#url').val()
if(!this._isValidURL(url)){var feed=this.allFeeds.findWhere({'title':url});if(feed){url=feed.get('url');}}
return{url:url,}},_isValidURL:function(str){var regexp=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/return regexp.test(str);}});Sourcemash.Views.ItemCardView=Backbone.View.extend({template:JST['feed-card'],initialize:function(options){this.listenTo(this.model,'change',this.render);this.render();},events:{"click #subscribe-switch":'subscribeFromSwitch',},subscribeFromSwitch:function(){if(this.model.get('subscribed')){this.model.save({'subscribed':false},{success:this.subscribed});mixpanel.track("Unsubscribed",{"Feed Title":this.model.get('title')})}else{this.model.save({'subscribed':true},{success:this.subscribed});mixpanel.track("Subscribed",{"Feed Title":this.model.get('title'),"Source":'feed page'})}},subscribed:function(feed){if(feed.get('subscribed')){toast("Subscribed!",3000);}else{toast("You have unsubscribed...",3000);}},render:function(){this.$el.html(this.template({model:this.model}));}});Sourcemash.Views.ItemCardView=Backbone.View.extend({template:JST['item-card'],initialize:function(options){this.listenTo(this.model,'change',this.render);this.render();},events:{'click .upvote':'upvote','click .downvote':'downvote','click .mark-read':'markRead','click .saved':'savedToggle'},upvote:function(){this.model.save({vote:1,voteSum:this._getNewVoteSum(1)},{success:this.voted});if(this.model.changedAttributes()){mixpanel.track("Upvoted",{"Item Title":this.model.get('title'),"Feed Title":this.model.feed.get('title')})
if(!this.model.feed.get('subscribed')){this.showSubscribeModal();}}},downvote:function(){this.model.save({vote:-1,voteSum:this._getNewVoteSum(-1)},{success:this.voted});if(this.model.changedAttributes()){mixpanel.track("Downvoted",{"Item Title":this.model.get('title'),"Feed Title":this.model.feed.get('title')})}},voted:function(){toast("Vote recorded!",3000);},showSubscribeModal:function(e){$('#subscribe-modal #unsubscribed-item-title').html(this.model.get('title'));$('#subscribe-modal #unsubscribed-feed-title').html(this.model.feed.get('title'));$('#subscribe-modal').openModal();mixpanel.track("Subscribe Modal",{"Item Title":this.model.get('title'),"Feed Title":this.model.feed.get('title')})},_getNewVoteSum:function(vote){return this.model.get('voteSum')+vote-this.model.get('vote')},markRead:function(){this.model.save({unread:false},{success:_.bind(this.openCard,this)});if(this.model.changedAttributes()){mixpanel.people.increment("items read")}},savedToggle:function(){if(this.model.get('saved')){this.model.save({saved:false},{success:this.savedToast});if(this.model.changedAttributes()){mixpanel.track("Saved",{"Item Title":this.model.get('title'),"Feed Title":this.model.feed.get('title')});}}else{this.model.save({saved:true},{success:this.savedToast});}},savedToast:function(item){if(item.get('saved')){toast("Saved!",3000);}else{toast("Unsaved...",3000)}},openCard:function(){this.$('.card-reveal').velocity({translateY:'-100%'},{duration:300,queue:false,easing:'easeInOutQuad'});},render:function(){this.$el.html(this.template({item:this.model}));}});Sourcemash.Routers.AppRouter=Backbone.Router.extend({routes:{"":"showProfile","feeds":"showFeeds","feeds/:id":"showFeed","categories":"showCategories","categories/:category":"showCategory","saved":"showSaved","browse/feeds":"browseFeeds"},showProfile:function(){var user=new Sourcemash.Models.User()
var profileView=new Sourcemash.Views.ProfileView({model:user});user.fetch({success:this._identifyUser});this._swapView(profileView);},showFeeds:function(){var feedsView=new Sourcemash.Views.FeedsView({collection:new Sourcemash.Collections.Feeds(),});feedsView.collection.fetch();feedsView.allFeeds.fetch({url:'/api/feeds/all'});this._swapView(feedsView);},browseFeeds:function(){var browseView=new Sourcemash.Views.BrowseView({collection:new Sourcemash.Collections.Feeds(),});browseView.collection.fetch({url:'/api/feeds/all'});this._swapView(browseView);},showFeed:function(id){var feed=new Sourcemash.Models.Feed({id:id});var feeds=new Sourcemash.Collections.Feeds([feed]);var feedItems=new Sourcemash.Collections.Items([],{feed:feed});var feedView=new Sourcemash.Views.FeedView({model:feed,collection:feedItems});feed.fetch();feedView.collection.fetch({feeds:feeds,success:function(){feedView.render()}});this._swapView(feedView);},showCategories:function(){var categoriesView=new Sourcemash.Views.CategoriesView({collection:new Sourcemash.Collections.Categories()});categoriesView.collection.fetch();this._swapView(categoriesView);},showCategory:function(keyword){var feeds=new Sourcemash.Collections.Feeds();var category=new Sourcemash.Models.Category({category:keyword});var categoryItems=new Sourcemash.Collections.Items([],{category:category});var categoryView=new Sourcemash.Views.CategoryView({model:category,collection:categoryItems});categoryView.collection.fetch({feeds:feeds,success:function(){categoryView.render()}});this._swapView(categoryView);},showSaved:function(){var feeds=new Sourcemash.Collections.Feeds();var savedItems=new Sourcemash.Collections.Items([],{saved:true});var savedView=new Sourcemash.Views.SavedView({collection:savedItems});savedView.collection.fetch({feeds:feeds,success:function(){savedView.render()}});this._swapView(savedView);},_swapView:function(view){if(this.currentView){if(this.currentView.close){this.currentView.close();}
this.currentView.remove();this.currentView.unbind();}
this.currentView=view;$('#app').html(view.render().$el);},_identifyUser:function(user){mixpanel.identify(user.get('email'));mixpanel.people.set_once('$created',new Date());mixpanel.people.set({"$email":user.get('email')});}})