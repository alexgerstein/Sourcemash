window.Sourcemash={Models:{},Collections:{},Views:{},Routers:{},initialize:function(){new Sourcemash.Routers.AppRouter();Backbone.history.start();}};var OriginalBackboneSync=Backbone.sync;Backbone.sync=function(method,model,options){if(!options.data&&model&&method==='update'){options.contentType='application/json';options.data=JSON.stringify(model.changedAttributes()||{});}
return OriginalBackboneSync.apply(this,arguments);};$(document).ready(function(){Sourcemash.initialize();});Sourcemash.Models.Category=Backbone.Model.extend({urlRoot:'/api/categories',initialize:function(){this.items=new Sourcemash.Collections.Items([],{category:this});}});Sourcemash.Models.Feed=Backbone.Model.extend({urlRoot:'/api/feeds',initialize:function(){this.items=new Sourcemash.Collections.Items([],{feed:this});},parse:function(response){if(response.feed){return response.feed;}
return response;}});Sourcemash.Models.Item=Backbone.Model.extend({urlRoot:'/api/items'});Sourcemash.Collections.Categories=Backbone.Collection.extend({model:Sourcemash.Models.Category,url:'/api/categories',parse:function(response){return response.categories;},comparator:function(item){return[parseInt(item.get('unread_count'))==0,item.get('category')]}});Sourcemash.Collections.Feeds=Backbone.Collection.extend({model:Sourcemash.Models.Feed,url:'/api/feeds',parse:function(response){return response.feeds;},comparator:function(feed){return[parseInt(feed.get('unread_count'))==0,feed.get('title')]}});Sourcemash.Collections.Items=Backbone.Collection.extend({model:Sourcemash.Models.Item,url:function(){if(this.feed){return'/api/feeds/'+this.feed.get('id')+'/items'}else if(this.category){return'/api/categories/'+this.category.get('category')+'/items'}},parse:function(response){return response.items;},initialize:function(items,options){this.feed=options.feed;this.category=options.category;}});Sourcemash.Views.ItemsView=Backbone.View.extend({initialize:function(options){this.listenTo(this.model,'sync change',this.render);this.listenTo(this.model.items,'sync change',this.render);this.itemViews=[];},render:function(){var content=this.template({model:this.model});this.$el.html(content);var itemViews=[];this.model.items.forEach(function(item){var itemCardView=new Sourcemash.Views.ItemCardView({model:item});$("#items").append(itemCardView.el)
itemViews.push(itemCardView)})
this.itemViews=itemViews;return this;},close:function(){this.remove();this.unbind();_.each(this.itemViews,function(itemView){itemView.remove();itemView.unbind();})}});Sourcemash.Views.CategoryView=Sourcemash.Views.ItemsView.extend({template:JST['category'],id:"category-items"});Sourcemash.Views.CategoriesView=Backbone.View.extend({template:JST['categories'],initialize:function(){this.listenTo(this.collection,'add sync remove change',this.render);},render:function(){var content=this.template({categories:this.collection.models})
this.$el.html(content);return this;},});Sourcemash.Views.FeedView=Sourcemash.Views.ItemsView.extend({template:JST['feed'],id:"feed-items"});Sourcemash.Views.FeedsView=Backbone.View.extend({template:JST['feeds'],initialize:function(options){var ExtendedTypeahead=Backbone.Typeahead.extend({template:JST['new_feed_form'],});this.allFeeds=new Sourcemash.Collections.Feeds({url:'/api/feeds/all'})
this.typeahead=new ExtendedTypeahead({collection:this.allFeeds,key:'title'});this.listenTo(this.collection,'sync',this.render);},events:{'submit #add_feed_form':'createFeed'},createFeed:function(e){e.preventDefault()
this.collection.create(this.newAttributes(),{success:this.updateCollection});},updateCollection:function(newFeed){this.$('#url').val('');newFeed.collection.fetch();toast('Feed added!',3000)
},render:function(){var content=this.template({feeds:this.collection.models})
this.$el.html(content);$('#typeahead').html(this.typeahead.render().el);return this;},newAttributes:function(){var url=this.$('#url').val()
if(!this._isValidURL(url)){var feed=this.allFeeds.findWhere({'title':url});if(feed){url=feed.get('url');}}
return{url:url,}},_isValidURL:function(str){var regexp=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/return regexp.test(str);}});Sourcemash.Views.ItemCardView=Backbone.View.extend({template:JST['item-card'],className:"item-card",initialize:function(options){this.render();this.listenTo(this.model,'sync',this.render);},events:{'click .upvote':'upvote','click .downvote':'downvote','click #mark-read':'markRead',},upvote:function(){this.model.save({vote:1,voteSum:this._getNewVoteSum(1)},{success:this.voted});},downvote:function(){this.model.save({vote:-1,voteSum:this._getNewVoteSum(-1)},{success:this.voted});},voted:function(){toast("Vote recorded!",3000)},_getNewVoteSum:function(vote){return this.model.get('voteSum')+vote-this.model.get('vote')},markRead:function(){this.model.save({unread:false});},render:function(){var content=this.template({item:this.model});$(content).appendTo(this.$el);}});Sourcemash.Routers.AppRouter=Backbone.Router.extend({routes:{"":"index","feeds/:id":"showFeed","categories":"showCategories","categories/:category":"showCategory"},index:function(){var feedsView=new Sourcemash.Views.FeedsView({collection:new Sourcemash.Collections.Feeds(),});feedsView.collection.fetch();feedsView.allFeeds.fetch();this._swapView(feedsView);},showFeed:function(id){var feed=new Sourcemash.Models.Feed({id:id});var feedView=new Sourcemash.Views.FeedView({model:feed});feed.fetch();feed.items.fetch();this._swapView(feedView);},showCategories:function(){var categoriesView=new Sourcemash.Views.CategoriesView({collection:new Sourcemash.Collections.Categories()});categoriesView.collection.fetch();this._swapView(categoriesView);},showCategory:function(keyword){var category=new Sourcemash.Models.Category({category:keyword});var categoryView=new Sourcemash.Views.CategoryView({model:category});category.fetch();category.items.fetch();this._swapView(categoryView);},_swapView:function(view){if(this.currentView){if(this.currentView.close){this.currentView.close();}
this.currentView.remove();}
this.currentView=view;$('#app').html(view.render().$el);}})